<!DOCTYPE html>
<html lang="en-us">
<head>

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    
    
        
        <meta name="twitter:card" content="summary_large_image"/>
        <meta name="twitter:image" content="/img/fire.jpg"/>
    



<meta name="twitter:title" content="Spark and the Minor Planets Center data"/>
<meta name="twitter:description" content=""/>
<meta name="twitter:site" content="@wilselwood"/>



  	<meta property="og:title" content="Spark and the Minor Planets Center data &middot; Parsecs Reach" />
  	<meta property="og:site_name" content="Parsecs Reach" />
  	<meta property="og:url" content="http://parsecsreach.com/post/spark_and_mpc/" />

    
       <meta property="og:image" content="/img/fire.jpg"/>
    

    
    <meta property="og:description" content="" />
  	<meta property="og:type" content="article" />
    <meta property="article:published_time" content="2017-12-02T08:55:24Z" />

    
    <meta property="article:tag" content="spark" />
    
    <meta property="article:tag" content="minor planets center" />
    
    <meta property="article:tag" content="asteroids" />
    
    

    <title>Spark and the Minor Planets Center data &middot; Parsecs Reach</title>

    
    <meta name="description" content="Introduction A few weeks ago I saw comments between @Sondy and @JLGalache talking about getting a list of asteroids with their date of discovery. The main data " />
    

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="/images/favicon.ico">
	  <link rel="apple-touch-icon" href="/images/apple-touch-icon.png" />

    <link rel="stylesheet" type="text/css" href="/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="/css/nav.css" />

    

    
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/styles/default.min.css">
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js"></script>
        
        <script>hljs.initHighlightingOnLoad();</script>
    

    
      
          <link href="/index.xml" rel="alternate" type="application/rss+xml" title="Parsecs Reach" />
      
      
    
    <meta name="generator" content="Hugo 0.31.1" />

    <link rel="canonical" href="http://parsecsreach.com/post/spark_and_mpc/" />

    
      
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": 
    },
    "author": {
        "@type": "Person",
        "name": ,
        
        "url": http://parsecsreach.com,
        "sameAs": [
            
            
             
             
             
             
             
            
        ],
        "description": Software Engineer - Sort of full stack but not the normal stack
        
    },
    "headline": Spark and the Minor Planets Center data,
    "name": Spark and the Minor Planets Center data,
    "wordCount": 1632,
    "timeRequired": "PT8M",
    "inLanguage": {
      "@type": "Language",
      "alternateName": en
    },
    "url": http://parsecsreach.com/post/spark_and_mpc/,
    "datePublished": 2017-12-02T08:55Z,
    "dateModified": 2017-12-02T08:55Z,
    
    "image": {
        "@type": "ImageObject",
        "url": http://parsecsreach.comimg/fire.jpg,
        "width": 3000,
        "height": 1445
    },
    
    "keywords": spark, minor planets center, asteroids,
    "description": ,
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": http://parsecsreach.com/post/spark_and_mpc/
    }
}
    </script>
    


    

    

      
      <script async src="https://www.googletagmanager.com/gtag/js?id=UA-89365253-1"></script>
      <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-89365253-1');
      </script>

    

    
</head>
<body class="nav-closed">

  <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        
        
        
            
            <li class="nav-opened" role="presentation">
            	<a href="/">Home</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="/about">About me</a>
            </li>
        
        
    </ul>

    
    <a class="subscribe-button icon-feed" href="/index.xml">Subscribe</a>
    
</div>
<span class="nav-cover"></span>


 <div class="site-wrapper">



  
  <header class="main-header post-head" style="background-image: url(/img/fire.jpg)">
  
  <nav class="main-nav overlay clearfix">


  
  
      <a class="menu-button" href="#"><span class="burger">&#9776;</span><span class="word">Menu</span></a>
  
  </nav>
</header>



<main class="content" role="main">




  <article class="post post">

    <header class="post-header">
        <h1 class="post-title">Spark and the Minor Planets Center data</h1>
        <small></small>

        <section class="post-meta">
        
          <time class="post-date" datetime="2017-12-02T08:55:24Z">
            Dec 2, 2017
          </time>
        
         
          <span class="post-tag small"><a href="http://parsecsreach.com/tags/spark/">#spark</a></span>
         
          <span class="post-tag small"><a href="http://parsecsreach.com/tags/minor-planets-center/">#minor planets center</a></span>
         
          <span class="post-tag small"><a href="http://parsecsreach.com/tags/asteroids/">#asteroids</a></span>
         
        </section>
    </header>

    <section class="post-content">
      

<h1 id="introduction">Introduction</h1>

<p>A few weeks ago I saw comments between <a href="https://twitter.com/sondy">@Sondy</a> and <a href="https://twitter.com/JLGalache">@JLGalache</a> talking about getting a list of asteroids with their date of discovery. The main data file lists the year of discovery but not the actual date. I thought there was a way to get this information by looking at the observation file and joining it to the main data file. Todo this I decided to use Apache Spark. In this post I&rsquo;ll go through setting up the spark environment and reading the json object file.</p>

<h2 id="what-is-spark">What is spark?</h2>

<p><a href="https://spark.apache.org/">Spark</a> is an in-memory distributed processing framework. It is one of the largest open source data processing frameworks. There is a core section and several modules built on top. For this we will be using Spark SQL.</p>

<h2 id="what-is-the-minor-planets-center">What is the Minor Planets Center?</h2>

<p>The <a href="http://www.minorplanetcenter.net/iau/mpc.html">minor planets center</a> is an organization that keeps track of observations of asteroids. They keep a list of all the known asteroids and all the observations people around the world have made. They publish this data in a range of formats from a fixed width text file to json. Their documentation has improved a lot in the last couple of years.</p>

<h2 id="what-data-are-we-looking-at">What data are we looking at?</h2>

<p>A JSON file which contains information about all the known asteroids. This has their orbital parameters, id, name, discovery year, etc. Don&rsquo;t worry too much we won&rsquo;t get in to orbital mechanics here. (Mostly because I struggle with it my self)</p>

<p>While these data files are not big data by any means they are real data that has actual quirks and is not tiny which makes them a good thing to practice with. They shouldn&rsquo;t take hours to process.</p>

<h1 id="assumptions">Assumptions</h1>

<p>I am going to assume you have a local java installation and an IDE you are comfortable with. You know some scala. You can probably work out whats going on but it will be a lot easier if you are aware of the scala syntax before you start reading this.</p>

<h1 id="setup">Setup</h1>

<p>First we need to go and get the data files. These are reasonably big. On the minor planets center <a href="http://www.minorplanetcenter.net/data">data page</a> there is a link to the <code>mpcorb_extended.json.gz</code> file. Download this. This might take a while. So feel free to get started with the next bit.</p>

<p>I use <a href="https://www.jetbrains.com/idea/">intelliJ</a>. So create a new <a href="https://gradle.org/">gradle</a> project. There is no particular reason I chose Gradle over SBT or maven only I have more experience with it. The basics of the project setup are easy enough. First add a few bits to mark the project as a scala project and create variables for versions of things. This will save repeating your self if you need to change them in the future. The versions I used were simply the latest version of spark and its matching scala version when I did this. Open up the build.gradle file.</p>

<pre><code class="language-groovy">apply plugin : 'scala' // Adding the scala flag adds steps to the build process for the scala compiler

project.ext.scalaVersion = '2.11.9'
project.ext.sparkVersion = '2.2.0'

sourceCompatibility = 1.8 // Use Java 1.8 compatibility. Mostly this is a hint for the IDE rather than the build.
</code></pre>

<p>Then add the following dependencies to the dependencies section of your gradle file, there should be a junit dependency there already.</p>

<pre><code class="language-groovy">    compile &quot;org.scala-lang:scala-library:${project.ext.scalaVersion}&quot;
    compile &quot;org.scala-lang:scala-reflect:${project.ext.scalaVersion}&quot;
    compile &quot;org.scala-lang:scala-compiler:${project.ext.scalaVersion}&quot;
    compile &quot;org.apache.spark:spark-core_2.11:${project.ext.sparkVersion}&quot;
    compile &quot;org.apache.spark:spark-sql_2.11:${project.ext.sparkVersion}&quot;
</code></pre>

<h1 id="development">Development</h1>

<p>Now we need some actual code. Create a file in the <code>src/main/scala/&lt;Your package here&gt;</code> directory called something like <code>orbitdates.scala</code></p>

<p>Create a main method:</p>

<pre><code class="language-scala">object OrbitDates {
  def main(args: Array[String]) : Unit = {
    // Our code will go here
  }
}
</code></pre>

<p>Note: with spark you must create a main method this way and not use the <code>extends App</code> style syntax because the objects will be serialised and sent to worker nodes by spark later on. You will get very strange errors due to the order that the generated main method does things.</p>

<p>It is probably worth adding a <code>println(&quot;hello world&quot;)</code> at this point and making sure the project builds and runs. <code>./gradlew build</code> from the command line or the gradle build button in your ide should run cleanly. There will probably be a lot of downloading to be done the first time.</p>

<p>The first step of a spark program is getting hold of the right kind of spark context or session.</p>

<pre><code class="language-scala">    val spark = SparkSession
      .builder()
      .master(&quot;local[2]&quot;) // if you have more cores or a cluster turn this up.
      .appName(&quot;Spark SQL join observations&quot;)
      .getOrCreate()
</code></pre>

<p>As we want to use Spark SQL we need a spark session. This needs to be told where our spark &ldquo;cluster&rdquo; is. For this we are just using local with two threads. If you have a more powerful machine feel free to turn up the number of threads. If you are lucky enough to have an access to a cluster you should put the address of the &ldquo;master&rdquo; node here. (Note: the master/slave terminology that spark uses is horrible. Controller/worker would make more sense and be less offensive)</p>

<p>The <code>.appName()</code> is just a name for your app. It can be anything. If you are running in a cluster this is what shows up on the web front end.</p>

<p>The <code>.getOrCreate()</code> call at the end of the chain returns the spark context you have just setup. If for some reason your code already has an active spark context this will handle that as well.</p>

<p>To make that work you will also need to include</p>

<pre><code class="language-scala">import org.apache.spark.sql._
import org.apache.spark.sql.catalyst.expressions.Substring
import org.apache.spark.sql.functions._
</code></pre>

<p>The first one covers the <code>SparkSession</code>. The other two we will get to later.</p>

<p>To make things clearer later I added a mapping from the arguments simply so I didn&rsquo;t have to remember if the data file was args(0) or args(34)</p>

<pre><code class="language-scala">val mpcobs = args(0) // The json data file of objects
</code></pre>

<p>Now we have the spark session and something holding the path to our input files we can start trying to read them. First lets start with the json data file.</p>

<pre><code class="language-scala">val orbRec = spark.read
      .option(&quot;multiLine&quot;, true)
      .json(mpcobs)
</code></pre>

<p>This will give us what is called a data frame in spark sql parlance. Basically its a lazy representation of the data file. Nothing will actually be done until we ask for something to be returned. <code>spark.read</code> contains methods for reading lots of different kinds of data sources. These data sources all have different options that can be applied to them. Here we ask to read a multi line json file. This option has only existed since spark 2.2. We need the multi line option due to the way the MPC json file is layed out.</p>

<p>This will give us access to the data for each object as a record. To see how the data looks you can use the <code>.show()</code> function. This will display a simple table of the data to stdout when the program is run. This is very useful for working out how your data looks. There is also <code>.describe(&quot;column name&quot;)</code> function which will give you statistical information about your column.</p>

<p>The next step is to sort out the number column and remove the brackets that are around it. After that we can find the correct column to use for the id.</p>

<pre><code class="language-scala">  .withColumn(&quot;number_formatted&quot;, new Column(Substring(col(&quot;Number&quot;).expr, lit(2).expr, (length(col(&quot;Number&quot;))-2).expr)))
  .withColumn(&quot;id&quot;, coalesce(col(&quot;number_formatted&quot;), col(&quot;Principal_desig&quot;)))
</code></pre>

<p>The first line adds an extra column that does a substring of the original column &ldquo;Number&rdquo; removing the first and last two characters from the column.
The second line creates a new column called &ldquo;id&rdquo; which will contain the &ldquo;number_formatted&rdquo; column if it is not null or it will use the &ldquo;Principal_desig&rdquo; column. The <code>coalesce</code> function is very useful when you need to pick the first non null column from a list of options.</p>

<p>Now you should have a block that looks like this:</p>

<pre><code class="language-scala">  val orbRec = spark.read
    .option(&quot;multiLine&quot;, true)
    .json(mpcobs)
    .withColumn(&quot;number_formatted&quot;, new Column(Substring(col(&quot;Number&quot;).expr, lit(2).expr, (length(col(&quot;Number&quot;))-2).expr)))
    .withColumn(&quot;id&quot;, coalesce(col(&quot;number_formatted&quot;), col(&quot;Principal_desig&quot;)))
</code></pre>

<p>This simple code will read in the file and create an &ldquo;id&rdquo; column. If you add a <code>orbRec.show(2)</code> on the end you should see a very long table like below. There will also be a load of logging of what spark is doing. It should end up in stderr rather than stdout. You can see the last two columns are the ones we added.</p>

<pre><code class="language-table">+-------------+----------+---------+--------+----------------------------------+---------+----+----+---------+----------+---------+--------+------+---------+-------+--------+------+---------------+--------------------------+----------+--------------+------------+--------+---------+---------------+----------+------------+---------------+---------+----------------+--------------+-------------+---+---------+---------+--------+----------+----+----------------+---+
|Aphelion_dist|Arc_length|Arc_years|Computer|Critical_list_numbered_object_flag|    Epoch|   G|   H|Hex_flags|  Last_obs|        M|NEO_flag|  Name|     Node|Num_obs|Num_opps|Number|One_km_NEO_flag|One_opposition_object_flag|Orbit_type|Orbital_period|Other_desigs|PHA_flag|     Peri|Perihelion_dist|Perturbers|Perturbers_2|Principal_desig|      Ref|Semilatus_rectum|Synodic_period|           Tp|  U|        a|        e|       i|         n| rms|number_formatted| id|
+-------------+----------+---------+--------+----------------------------------+---------+----+----+---------+----------+---------+--------+------+---------+-------+--------+------+---------------+--------------------------+----------+--------------+------------+--------+---------+---------------+----------+------------+---------------+---------+----------------+--------------+-------------+---+---------+---------+--------+----------+----+----------------+---+
|     2.976646|      null|1801-2017|MPCLINUX|                              null|2458000.5|0.12|3.34|     0000|2017-03-05|309.49412|    null| Ceres| 80.30888|   6672|     113|   (1)|           null|                      null|       MBA|     4.6037329|   [1943 XB]|    null| 73.02368|      2.5581728|       M-v|         30h|        A899 OF|MPO399990|       1.3757948|       1.27749|2458236.41089|  0|2.7674094|0.0756074|10.59322|0.21408881| 0.6|               1|  1|
|    3.4125514|      null|1821-2017|MPCLINUX|                              null|2458000.5|0.11|4.13|     0000|2017-10-05|291.65136|    null|Pallas|173.08718|   7910|     108|   (2)|           null|                      null|       MBA|     4.6179031|        null|    null|309.99154|       2.133619|       M-v|         28h|           null|MPO421624|        1.312813|     1.2764032|2458320.73644|  0|2.7730852|0.2305974|34.83792|0.21343186|0.58|               2|  2|
+-------------+----------+---------+--------+----------------------------------+---------+----+----+---------+----------+---------+--------+------+---------+-------+--------+------+---------------+--------------------------+----------+--------------+------------+--------+---------+---------------+----------+------------+---------------+---------+----------------+--------------+-------------+---+---------+---------+--------+----------+----+----------------+---+
only showing top 2 rows

</code></pre>

<p>If you get errors about array index out of bounds you may have forgotten to pass the parameter for where the data file is.</p>

<p>Now you can start to explore a bit. Find out the stats of the columns using the <code>.describe()</code> function. Play with the <code>.select()</code> function to limit the number of columns. The <code>.where()</code> function can be used to filter the data. You can use <code>.agg()</code> with <code>min()</code> and<code>max()</code> to aggregate data. The <code>.count()</code> function will return the number of rows in a data set.</p>

<h2 id="challenge">Challenge</h2>

<ul>
<li>How many asteroids were first observed in the year 2000?</li>
</ul>

<p>The first person to send me a tweet with the answer will get a virtual hi-five and some kudos.</p>

<h1 id="conclusion">Conclusion</h1>

<p>Here we are going to leave it for today. I&rsquo;m planning to do another couple of posts. One reading the observation data file and another on joining every thing up. I hope this is useful and you found it interesting. If you did or you have questions please let me know on twitter.</p>

<h1 id="thanks">Thanks</h1>

<p>Thanks to the Minor planet center for making this data freely available.</p>

<p>Thanks to Sondy and JL for the idea.</p>

    </section>


  <footer class="post-footer">


    








<figure class="author-image">
    <a class="img" href="http://parsecsreach.com" style="background-image: url(/img/profilePic.jpg)"><span class="hidden">Wil Selwood's Picture</span></a>
</figure>


<section class="author">
  <h4><a href="http://parsecsreach.com">Wil Selwood</a></h4>
  
  <p>Software Engineer - Sort of full stack but not the normal stack</p>
  
  <div class="author-meta">
    <span class="author-location icon-location">Oxfordshire, UK</span>
    <span class="author-link icon-link"><a href="http://parsecsreach.com">http://parsecsreach.com</a></span>
  </div>
</section>




    
<section class="share">
  <h4>Share this post</h4>
  <a class="icon-twitter" style="font-size: 1.4em" href="https://twitter.com/share?text=Spark%20and%20the%20Minor%20Planets%20Center%20data&nbsp;-&nbsp;Parsecs%20Reach&amp;url=http%3a%2f%2fparsecsreach.com%2fpost%2fspark_and_mpc%2f"
      onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
      <span class="hidden">Twitter</span>
  </a>
  <a class="icon-facebook" style="font-size: 1.4em" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fparsecsreach.com%2fpost%2fspark_and_mpc%2f"
      onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
      <span class="hidden">Facebook</span>
  </a>
  <a class="icon-google-plus" style="font-size: 1.4em" href="https://plus.google.com/share?url=http%3a%2f%2fparsecsreach.com%2fpost%2fspark_and_mpc%2f"
     onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
      <span class="hidden">Google+</span>
  </a>
</section>



    





  </footer>
</article>

</main>


  <aside class="read-next">
  
  
      <a class="read-next-story prev" style="background-image: url(/img/phesent.jpg)" href="/post/introduction/">
          <section class="post">
              <h2>Introduction</h2>
          </section>
      </a>
  
</aside>



    <footer class="site-footer clearfix">
        <section class="copyright"><a href="">Parsecs Reach</a> All rights reserved - 2017</section>
        
        <section class="poweredby">Proudly generated by <a class="icon-hugo" href="http://gohugo.io">HUGO</a>, with <a class="icon-theme" href="https://github.com/vjeantet/hugo-theme-casper">Casper</a> theme</section>
        
    </footer>
    </div>
    <script type="text/javascript" src="/js/jquery.js"></script>
    <script type="text/javascript" src="/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/js/index.js"></script>
    
</body>
</html>

